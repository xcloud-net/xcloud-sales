#å®šä¹‰Nginxè¿è¡Œçš„ç”¨æˆ·å’Œç”¨æˆ·ç»„
#user www www;
#user root;
user nginx;

#################### http://nginx.org/en/docs/ #############################

#ä¸€èˆ¬ä¸€ä¸ªè¿›ç¨‹è¶³å¤Ÿäº†ï¼Œä½ å¯ä»¥æŠŠè¿æ¥æ•°è®¾å¾—å¾ˆå¤§ã€‚ï¼ˆworker_processes: 1ï¼Œworker_connections: 10,000ï¼‰
#å¦‚æœæœ‰SSLã€gzipè¿™äº›æ¯”è¾ƒæ¶ˆè€—CPUçš„å·¥ä½œï¼Œè€Œä¸”æ˜¯å¤šæ ¸CPUçš„è¯ï¼Œå¯ä»¥è®¾ä¸ºå’ŒCPUçš„æ•°é‡ä¸€æ ·ã€‚(worker_processes: CPUæ ¸å¿ƒæ•°)
#æˆ–è€…è¦å¤„ç†å¾ˆå¤šå¾ˆå¤šçš„å°æ–‡ä»¶ï¼Œè€Œä¸”æ–‡ä»¶æ€»å¤§å°æ¯”å†…å­˜å¤§å¾ˆå¤šçš„æ—¶å€™ï¼Œä¹Ÿå¯ä»¥æŠŠè¿›ç¨‹æ•°å¢åŠ ï¼Œä»¥å……åˆ†åˆ©ç”¨IOå¸¦å®½ï¼ˆä¸»è¦ä¼¼ä¹æ˜¯IOæ“ä½œæœ‰blockï¼‰
#æŸ¥çœ‹cpuä¿¡æ¯ï¼šcat /proc/cpuinfo
worker_processes 1;

#å…¨å±€é”™è¯¯æ—¥å¿—å®šä¹‰ç±»å‹,[ debug | info | notice | warn | error | crit ]
error_log /var/log/nginx/error.log warn;
#è¿›ç¨‹æ–‡ä»¶
pid /var/run/nginx.pid;

events {
    #å‚è€ƒäº‹ä»¶æ¨¡å‹,use [ kqueue | rtsig | epoll | /dev/poll | select | poll ];
    #epollæ¨¡å‹æ˜¯Linux 2.6ä»¥ä¸Šç‰ˆæœ¬å†…æ ¸ä¸­çš„é«˜æ€§èƒ½ç½‘ç»œI/Oæ¨¡å‹,å¦‚æœè·‘åœ¨FreeBSDä¸Šé¢,å°±ç”¨kqueueæ¨¡å‹.
    #use epoll;

    #å•è¿›ç¨‹æœ€å¤§è¿æ¥æ•°ï¼Œå—ç³»ç»Ÿè¿›ç¨‹æœ€å¤§å¯æ‰“å¼€æ–‡ä»¶æ•°é™åˆ¶ï¼Œé»˜è®¤æ˜¯65535
    #ulimit -n æŸ¥çœ‹ç³»ç»Ÿæœ€å¤§å€¼
    worker_connections 40000;
}

http {
    #æ–‡ä»¶æ‰©å±•åä¸æ–‡ä»¶ç±»å‹æ˜ å°„è¡¨
    include /etc/nginx/mime.types;
    #é»˜è®¤æ–‡ä»¶ç±»å‹
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
    '$status $body_bytes_sent "$http_referer" '
    '"$http_user_agent" "$http_x_forwarded_for"';

    #https://www.cnblogs.com/nethrd/p/9712367.html
    #https://nginx.org/en/docs/http/ngx_http_log_module.html#log_format
    #jsonæ—¥å¿—-æ•°å€¼ä¹Ÿæœ€å¥½ç”¨â€œâ€åŒ…èµ·æ¥ï¼Œé˜²æ­¢æŸäº›æƒ…å†µä¸‹æ˜¯â€œ-â€å¯¼è‡´jsonæ— æ³•è§£æ
    log_format  log_json  '{'
                          '"remote_addr": "$remote_addr",'
                          '"remote_user": "$remote_user",'
                          '"request_method": "$request_method",'
                          '"request_path":"$request_uri",'
                          '"request_full_url": "$scheme://$http_host$request_uri",'
                          '"http_domain":"$host",'
                          '"http_scheme":"$scheme",'
                          '"http_host":"$http_host",'
                          '"http_status": "$status",'
                          '"http_referer": "$http_referer",'
                          '"http_trace_id": "$http_trace_id",'
                          '"http_x_forwarded_for": "$http_x_forwarded_for",'
                          '"http_port":"$server_port",'
                          '"http_user_agent": "$http_user_agent",'
                          '"upstream_time":"$upstream_response_time",'
                          '"upstream_addr":"$upstream_addr",'
                          '"response_bytes_sent": "$body_bytes_sent",'
                          '"response_time": "$request_time",'
                          '"time_local": "$time_local",'
                          '"@timestamp":"$time_iso8601"'
                          '}';

    #å–æ¶ˆå…¨å±€æ—¥å¿—
    #access_log /var/log/nginx/access.log main;
    #é»˜è®¤ç¼–ç 
    charset utf-8;

    #ä¸è¿‡æ»¤å¸¦ä¸‹åˆ’çº¿çš„headï¼Œé»˜è®¤æ˜¯off
    underscores_in_headers on;

    #å¼€å¯ç›®å½•åˆ—è¡¨è®¿é—®,åˆé€‚ä¸‹è½½æœåŠ¡å™¨,é»˜è®¤å…³é—­.
    #æ˜¾ç¤ºç›®å½•
    #autoindex on;
    #æ˜¾ç¤ºæ–‡ä»¶å¤§å° é»˜è®¤ä¸ºon,æ˜¾ç¤ºå‡ºæ–‡ä»¶çš„ç¡®åˆ‡å¤§å°,å•ä½æ˜¯bytes æ”¹ä¸ºoffå,æ˜¾ç¤ºå‡ºæ–‡ä»¶çš„å¤§æ¦‚å¤§å°,å•ä½æ˜¯kBæˆ–è€…MBæˆ–è€…GB
    #autoindex_exact_size on;
    #æ˜¾ç¤ºæ–‡ä»¶æ—¶é—´ é»˜è®¤ä¸ºoff,æ˜¾ç¤ºçš„æ–‡ä»¶æ—¶é—´ä¸ºGMTæ—¶é—´ æ”¹ä¸ºonå,æ˜¾ç¤ºçš„æ–‡ä»¶æ—¶é—´ä¸ºæ–‡ä»¶çš„æœåŠ¡å™¨æ—¶é—´
    #autoindex_localtime on;

    #å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼,sendfileæŒ‡ä»¤æŒ‡å®šnginxæ˜¯å¦è°ƒç”¨sendfileå‡½æ•°æ¥è¾“å‡ºæ–‡ä»¶,å¯¹äºæ™®é€šåº”ç”¨è®¾ä¸º on,
    #å¦‚æœç”¨æ¥è¿›è¡Œä¸‹è½½ç­‰åº”ç”¨ç£ç›˜IOé‡è´Ÿè½½åº”ç”¨,å¯è®¾ç½®ä¸ºoff,ä»¥å¹³è¡¡ç£ç›˜ä¸ç½‘ç»œI/Oå¤„ç†é€Ÿåº¦,é™ä½ç³»ç»Ÿçš„è´Ÿè½½.
    #æ³¨æ„ï¼šå¦‚æœå›¾ç‰‡æ˜¾ç¤ºä¸æ­£å¸¸æŠŠè¿™ä¸ªæ”¹æˆoff.
    sendfile on;
    #é˜²æ­¢ç½‘ç»œé˜»å¡
    #tcp_nopush on;
    #é˜²æ­¢ç½‘ç»œé˜»å¡
    #tcp_nodelay on;
    keepalive_timeout 65;

    #å¼€å¯gzip;
    #http://nginx.org/en/docs/http/ngx_http_gzip_module.html#gzip_proxied
    gzip on;
    gzip_static on;
    gzip_min_length 1k;
    gzip_comp_level 5;
    gzip_disable "MSIE [1-6]\.";
    gzip_vary on;
    gzip_proxied any;
    gzip_http_version 1.0;

    gzip_types 
    text/plain  
    text/css 
    text/javascript 
    application/javascript 
    application/x-javascript
    application/xml 
    image/svg+xml
    image/jpeg 
    image/gif 
    image/png;

    #http://nginx.org/en/docs/http/ngx_http_proxy_module.html
    proxy_redirect off;
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_http_version 1.1;
    
    #handle http error
    proxy_intercept_errors on;

    #proxy cache configuration
    proxy_cache_path /nginx-cache levels=1:2 keys_zone=cache_one:100m inactive=1d max_size=10g;

    upstream api_gateway_upstream {
        server api-gateway:8888 weight=10;
    }
    
    upstream web_ui_upstream {
        server web-ui:9999 weight=10;
    }
    
    #ç¦æ­¢å…¶ä»–åŸŸåå’Œipè®¿é—®
    server {
        listen 80 default;
        server_name _;
        return 403;
    }
    #ssl
    server {
        listen 443 ssl default;
        server_name _;
        
        #é…ç½®è¯ä¹¦ä½ç½®
        ssl_certificate /nginx-cert/your-domain.com/xx.pem;
        #é…ç½®ç§˜é’¥ä½ç½®
        ssl_certificate_key /nginx-cert/your-domain.com/xx.key;

        return 403;
    }
    
    server {
        listen 8888 ssl;
        server_name your-domain.com;
    
        #é…ç½®è¯ä¹¦ä½ç½®
        ssl_certificate /nginx-cert/your-domain.com/xx.pem;
        #é…ç½®ç§˜é’¥ä½ç½®
        ssl_certificate_key /nginx-cert/your-domain.com/xx.key;
    
        ssl_session_timeout 5m;
        ssl_protocols SSLv2 SSLv3 TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
        ssl_prefer_server_ciphers on;
    
        client_max_body_size 20m;
    
		map $time_iso8601 $logdate {
            '~^(?<ymd>\d{4}-\d{2}-\d{2})' $ymd;
            default    'date-not-found';
        }

        access_log /var/log/nginx/access.gateway.$logdate.log log_json;
        error_log /var/log/nginx/access.gateway.$logdate.log error;
    
        location / {
            proxy_pass http://api_gateway_upstream;
        }

        # websocket channel
        location /api/platform-ws/ {
            proxy_pass http://api_gateway_upstream;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        #hide internal api from internet
        location /internal-api/ {
            deny all;
        }

        #hide sensitive access
        location ~* .*\.(asp|aspx|jsp|php|php5|py|sh|ps|sql|db|git|svn)$ {
            deny all;
        }

        #handle static data
        location ~* .*\.(js|css|jpg|jpeg|png|gif)$ {
            expires max;
            add_header x-route 'gateway-static';

            proxy_cache cache_one;
            proxy_cache_valid 200 302 24h;
            proxy_cache_valid 301 30d;
            proxy_cache_valid any 5m;

            #access_log off;
            proxy_pass http://api_gateway_upstream;
        }
    
    }
    
    server {
        listen 80;
        server_name www.your-domain.com your-domain.com;
        #å¼ºåˆ¶https
        rewrite ^(.*)$ https://your-domain.com$1 permanent;
    }

    server {
        listen 443 ssl;
        server_name www.your-domain.com your-domain.com;
    
        #é…ç½®è¯ä¹¦ä½ç½®
        ssl_certificate /nginx-cert/your-domain.com/xx.pem;
        #é…ç½®ç§˜é’¥ä½ç½®
        ssl_certificate_key /nginx-cert/your-domain.com/xx.key;
    
        ssl_session_timeout 5m;
        ssl_protocols SSLv2 SSLv3 TLSv1 TLSv1.1 TLSv1.2;
        ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv2:+EXP;
        ssl_prefer_server_ciphers on;
    
        client_max_body_size 20m;
    
        #if($host != 'your-domain.com')
        if ($host = 'wwww.your-domain.com') {
            # remove www.,just keep xx.com
            rewrite ^(.*)$ https://your-domain.com$1 permanent;
        }
    
        map $time_iso8601 $logdate {
            '~^(?<ymd>\d{4}-\d{2}-\d{2})' $ymd;
            default    'date-not-found';
        }

        access_log /var/log/nginx/access.ui.$logdate.log main;
        error_log /var/log/nginx/error.ui.$logdate.log error;

        location / {
            #access_log off;
            proxy_pass http://web_ui_upstream;
            #rewrite / /store;
        }

        location /shop {
            #test success ğŸ‘‡
            rewrite /shop /store;
        }
    
        location /store-manage/ {
            #access_log off;
            add_header x-route 'store-manage';
            proxy_pass http://web_ui_upstream;
        }

        location ~* /store-manage/.*\.(js|css|jpg|jpeg|png|gif)$ {
            expires max;
            add_header x-route 'store-manage-static';
            #access_log off;
            proxy_pass http://web_ui_upstream;
        }
    
        location /store/ {
            #access_log off;
            add_header x-route 'store';
            proxy_pass http://web_ui_upstream;
        }

        location ~* /store/.*\.(js|css|jpg|jpeg|png|gif)$ {
            expires max;
            add_header x-route 'store-static';
            #access_log off;
            proxy_pass http://web_ui_upstream;
        }
    
    }
    
    #include /etc/nginx/conf.d/*.conf;

}